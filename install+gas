#!/bin/bash

# Параметры
MINER_DIR="$HOME/heminetwork_v1.0.0_linux_amd64"
CONFIG_FILE="$MINER_DIR/config.sh"

# Проверка прав root
if [ "$EUID" -ne 0 ]; then
    echo "Ошибка: Скрипт должен быть запущен с правами root (используйте sudo)."
    exit 1
fi

# Устанавливаем пакеты
install_packages() {
    echo "Проверка необходимых пакетов..."
    # Ваши пакеты
}

install_packages

# Проверка установки майнера
if [ -d "$MINER_DIR" ]; then
    echo "Майнер уже установлен, пропускаем установку."
else
    echo "Майнер не найден, начинаем установку..."
    # Установка и скачивание
fi

# --- Настройка конфига при каждом запуске скрипта ---
echo "===== Настройка майнера ====="
read -p "Введите ваш приватный ключ BTC: " btc_key
read -p "Введите POPM_STATIC_FEE (например 4): " static_fee
if ! [[ "$static_fee" =~ ^[0-9]+$ ]]; then
    echo "Ошибка: POPM_STATIC_FEE должен быть числом!"
    exit 1
fi
cat > "$CONFIG_FILE" <<EOF
#!/bin/bash
export POPM_BTC_PRIVKEY=${btc_key}
export POPM_STATIC_FEE=${static_fee}
export POPM_BFG_URL=wss://pop.hemi.network/v1/ws/public
export POPM_BTC_CHAIN_NAME=mainnet
EOF
chmod +x "$CONFIG_FILE"
echo "✅ Конфиг обновлен!"

# Загружаем параметры из нового конфига
source "$CONFIG_FILE"

# --- Основной цикл мониторинга и запуска майнера ---
cd "$MINER_DIR" || exit 1

# Проверка газа перед запуском майнера
echo "Ожидаем подходящий газ для запуска майнера..."
while true; do
    gas_price=$(curl -s https://mempool.space/api/v1/fees/recommended | jq -r '.fastestFee' 2>/dev/null)
    if [ -z "$gas_price" ] || ! [[ "$gas_price" =~ ^[0-9]+$ ]]; then
        echo "$(date '+%Y-%m-%d %H:%M:%S') - Ошибка: Не удалось получить данные о газе. Повтор через 30 секунд..."
        sleep 30
        continue
    fi
    echo "$(date '+%Y-%m-%d %H:%M:%S') - Газ: $gas_price sat/vB (Порог: $POPM_STATIC_FEE sat/vB)"

    # Если газ в норме, запускаем майнер
    if [ "$gas_price" -le "$POPM_STATIC_FEE" ]; then
        echo "Газ в норме, запускаем майнер..."
        screen -dmS hemi_miner bash -c "cd $MINER_DIR && source $CONFIG_FILE && ./popmd"
        break
    else
        echo "Газ слишком высокий, продолжаем ожидание..."
        sleep 30
    fi
done

# Следим за процессом майнера
echo "Майнер запущен. Для остановки используйте 'screen -r hemi_miner' и Ctrl+C."
