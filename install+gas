#!/bin/bash

# ==== ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ====
MINER_DIR="$HOME/heminetwork_v1.0.0_linux_amd64"
CONFIG_FILE="$MINER_DIR/config.sh"
MONITOR_SCREEN="tracker"
MINER_SCREEN="hemi_miner"
PACKAGES="jq curl screen wget unzip nano"

# ==== ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ñ€Ð°Ð² ====
if [ "$EUID" -ne 0 ]; then
    echo "ÐžÑˆÐ¸Ð±ÐºÐ°: Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚ Ñ Ð¿Ñ€Ð°Ð²Ð°Ð¼Ð¸ root (sudo)."
    exit 1
fi

# ==== Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ð°ÐºÐµÑ‚Ð¾Ð² ====
install_packages() {
    echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð¿Ð°ÐºÐµÑ‚Ð¾Ð²..."
    for pkg in $PACKAGES; do
        if ! dpkg -l | grep -q " $pkg "; then
            echo "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ $pkg..."
            apt update && apt install -y "$pkg"
        fi
    done
}
install_packages

# ==== Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¼Ð°Ð¹Ð½ÐµÑ€Ð° ====
if [ ! -d "$MINER_DIR" ]; then
    echo "Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¼Ð°Ð¹Ð½ÐµÑ€..."
    wget https://github.com/hemilabs/heminetwork/releases/download/v1.0.0/heminetwork_v1.0.0_linux_amd64.tar.gz
    tar -xvzf heminetwork_v1.0.0_linux_amd64.tar.gz
    mv heminetwork_v1.0.0_linux_amd64 "$HOME/"
fi

# ==== ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÐºÐ¾Ð½Ñ„Ð¸Ð³Ð° ====
echo "===== ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¼Ð°Ð¹Ð½ÐµÑ€Ð° ====="
read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ BTC: " btc_key
read -p "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ POPM_STATIC_FEE (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ 4): " static_fee
if ! [[ "$static_fee" =~ ^[0-9]+$ ]]; then
    echo "ÐžÑˆÐ¸Ð±ÐºÐ°: POPM_STATIC_FEE Ð´Ð¾Ð»Ð¶Ð½Ð¾ Ð±Ñ‹Ñ‚ÑŒ Ñ‡Ð¸ÑÐ»Ð¾Ð¼!"
    exit 1
fi

cat > "$CONFIG_FILE" <<EOF
#!/bin/bash
export POPM_BTC_PRIVKEY=${btc_key}
export POPM_STATIC_FEE=${static_fee}
export POPM_BFG_URL=wss://pop.hemi.network/v1/ws/public
export POPM_BTC_CHAIN_NAME=mainnet
EOF

chmod +x "$CONFIG_FILE"
source "$CONFIG_FILE"
echo "âœ… ÐšÐ¾Ð½Ñ„Ð¸Ð³ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½."

# ==== Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° ====
monitor_gas() {
    echo "â–¶ï¸ Ð—Ð°Ð¿ÑƒÑÐº Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° Ð³Ð°Ð·Ð°..."
    while true; do
        gas_price=$(curl -s https://mempool.space/api/v1/fees/recommended | jq -r '.fastestFee')
        if [[ ! "$gas_price" =~ ^[0-9]+$ ]]; then
            echo "â—ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð³Ð°Ð·. ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€ Ñ‡ÐµÑ€ÐµÐ· 30 ÑÐµÐº."
            sleep 30
            continue
        fi
        echo "$(date '+%H:%M:%S') Ð“Ð°Ð·: $gas_price sat/vB (Ð¿Ð¾Ñ€Ð¾Ð³: $POPM_STATIC_FEE)"

        miner_running=$(screen -ls | grep "$MINER_SCREEN")
        if [ "$gas_price" -le "$POPM_STATIC_FEE" ]; then
            if [ -z "$miner_running" ]; then
                echo "âœ… Ð“Ð°Ð· Ð½Ð¾Ñ€Ð¼ ($gas_price), Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð°Ð¹Ð½ÐµÑ€..."
                screen -dmS "$MINER_SCREEN" bash -c "cd $MINER_DIR && source config.sh && ./popmd"
            else
                echo "âœ… ÐœÐ°Ð¹Ð½ÐµÑ€ ÑƒÐ¶Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚."
            fi
        else
            if [ -n "$miner_running" ]; then
                echo "â—ï¸ Ð“Ð°Ð· Ð²Ñ‹ÑÐ¾ÐºÐ¸Ð¹ ($gas_price), Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¼Ð°Ð¹Ð½ÐµÑ€..."
                screen -S "$MINER_SCREEN" -X quit
            else
                echo "â—ï¸ ÐœÐ°Ð¹Ð½ÐµÑ€ ÑƒÐ¶Ðµ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½."
            fi
        fi
        sleep 30
    done
}

# ==== Ð—Ð°Ð¿ÑƒÑÐº Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° ====
echo ""
echo "ðŸš€ Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³ Ð² screen '$MONITOR_SCREEN'..."
screen -dmS "$MONITOR_SCREEN" bash -c "$(declare -f monitor_gas); monitor_gas"

echo "âœ… Ð’ÑÑ‘ Ð³Ð¾Ñ‚Ð¾Ð²Ð¾!"
echo "â„¹ï¸ Ð”Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð°: screen -r $MONITOR_SCREEN"
echo "â„¹ï¸ Ð§Ñ‚Ð¾Ð±Ñ‹ Ð²Ñ‹Ð¹Ñ‚Ð¸ Ð¸Ð· screen Ð±ÐµÐ· Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸: Ctrl+A, Ð·Ð°Ñ‚ÐµÐ¼ D"
