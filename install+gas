#!/bin/bash

# === –ü–∞—Ä–∞–º–µ—Ç—Ä—ã ===
MINER_DIR="$HOME/heminetwork_v1.0.0_linux_amd64"
CONFIG_FILE="$MINER_DIR/config.sh"
MONITOR_SCREEN="tracker"

# === –ü—Ä–æ–≤–µ—Ä–∫–∞ root ===
if [ "$EUID" -ne 0 ]; then
    echo "–û—à–∏–±–∫–∞: –ó–∞–ø—É—Å—Ç–∏ —Å–∫—Ä–∏–ø—Ç —Å sudo!"
    exit 1
fi

# === –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞–∫–µ—Ç–æ–≤ ===
apt update -y
apt install -y jq curl screen wget unzip nano

# === –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∞–π–Ω–µ—Ä–∞, –µ—Å–ª–∏ –Ω–µ—Ç ===
if [ ! -d "$MINER_DIR" ]; then
    echo "–ú–∞–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º..."
    wget https://github.com/hemilabs/heminetwork/releases/download/v1.0.0/heminetwork_v1.0.0_linux_amd64.tar.gz
    tar -xvzf heminetwork_v1.0.0_linux_amd64.tar.gz
else
    echo "–ú–∞–π–Ω–µ—Ä —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω."
fi

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–Ω—Ñ–∏–≥–∞ ===
echo ""
echo "===== –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞–π–Ω–µ—Ä–∞ ====="
read -p "–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –ø—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á BTC: " btc_key
read -p "–í–≤–µ–¥–∏—Ç–µ POPM_STATIC_FEE (–Ω–∞–ø—Ä–∏–º–µ—Ä 4): " static_fee

cat > "$CONFIG_FILE" <<EOF
#!/bin/bash
export POPM_BTC_PRIVKEY=${btc_key}
export POPM_STATIC_FEE=${static_fee}
export POPM_BFG_URL=wss://pop.hemi.network/v1/ws/public
export POPM_BTC_CHAIN_NAME=mainnet
EOF

chmod +x "$CONFIG_FILE"
source "$CONFIG_FILE"

echo "‚úÖ –ö–æ–Ω—Ñ–∏–≥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω."
echo ""

# === –§—É–Ω–∫—Ü–∏—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ ===
monitor() {
    echo "‚ñ∂Ô∏è –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≥–∞–∑–∞ –∑–∞–ø—É—â–µ–Ω..."
    MINER_RUNNING=0

    while true; do
        gas_price=$(curl -s https://mempool.space/api/v1/fees/recommended | jq -r '.fastestFee')
        if [[ "$gas_price" =~ ^[0-9]+$ ]]; then
            echo "$(date '+%H:%M:%S') - –ì–∞–∑: $gas_price sat/vB (–ø–æ—Ä–æ–≥: $POPM_STATIC_FEE)"

            if [ "$gas_price" -le "$POPM_STATIC_FEE" ]; then
                if [ "$MINER_RUNNING" -eq 0 ]; then
                    echo "‚úÖ –ì–∞–∑ –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π ($gas_price), –∑–∞–ø—É—Å–∫–∞–µ–º –º–∞–π–Ω–µ—Ä..."
                    cd "$MINER_DIR" && source config.sh && ./popmd &
                    MINER_PID=$!
                    MINER_RUNNING=1
                fi
            else
                if [ "$MINER_RUNNING" -eq 1 ]; then
                    echo "‚ùå –ì–∞–∑ –≤—ã—Å–æ–∫–∏–π ($gas_price), –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∞–π–Ω–µ—Ä..."
                    kill "$MINER_PID" 2>/dev/null
                    MINER_RUNNING=0
                fi
            fi
        else
            echo "$(date '+%H:%M:%S') - –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Ü–µ–Ω—É –≥–∞–∑–∞."
        fi
        sleep 30
    done
}

# === –ó–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –≤ screen ===
echo ""
echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –≤ screen '$MONITOR_SCREEN'..."
screen -dmS "$MONITOR_SCREEN" bash -c "bash $0 monitor"

echo "‚úÖ –í—Å—ë –≥–æ—Ç–æ–≤–æ!"
echo "‚ÑπÔ∏è –î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞: screen -r $MONITOR_SCREEN"
echo "‚ÑπÔ∏è –ß—Ç–æ–±—ã –≤—ã–π—Ç–∏ –∏–∑ screen –±–µ–∑ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: Ctrl+A, –∑–∞—Ç–µ–º D"

# === –ï—Å–ª–∏ –∑–∞–ø—É—Å–∫ —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–º monitor ===
if [ "$1" = "monitor" ]; then
    source "$CONFIG_FILE"
    monitor
fi
