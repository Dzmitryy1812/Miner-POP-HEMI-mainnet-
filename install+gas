#!/bin/bash

echo "=== HEMI Miner Installer ==="

# Обновление системы
sudo apt update && sudo apt upgrade -y
sudo apt install wget unzip nano curl screen -y

# Скачиваем майнер
wget https://github.com/hemilabs/heminetwork/releases/download/v1.0.0/heminetwork_v1.0.0_linux_amd64.tar.gz
tar -xvzf heminetwork_v1.0.0_linux_amd64.tar.gz
cd heminetwork_v1.0.0_linux_amd64

# Запрос минимального значения газа от пользователя
read -p "Введите минимальное значение газа (например, 2): " min_gas

# Запуск майнера
echo "Запуск майнера..."
screen -S hemi_miner -d -m ./popmd

# Проверка газа после запуска майнера
while true; do
    current_gas=$(curl -s https://api.hemi.network/gas/ | jq -r '.gas | tonumber')
    echo "Текущий газ: $current_gas sat/vB"
    
    if [ "$current_gas" -ge "$min_gas" ]; then
        echo "Газ в норме, продолжаем работу..."
        break
    else
        echo "Газ слишком низкий, проверяем через 30 секунд..."
        sleep 30
    fi
done

# Настройка конфигурации
echo "===== Настройка майнера ====="
read -p "Введите ваш приватный ключ BTC: " btc_key
read -p "Введите POPM_STATIC_FEE (например, 4): " static_fee

cat > config.sh <<EOF
export POPM_BTC_PRIVKEY=${btc_key}
export POPM_STATIC_FEE=${static_fee}
export POPM_BFG_URL=wss://pop.hemi.network/v1/ws/public
export POPM_BTC_CHAIN_NAME=mainnet
EOF

chmod +x config.sh

echo "✅ Конфиг успешно создан!"
cat config.sh

# Меню
while true; do
    echo ""
    echo "1) Запустить мониторинг газа"
    echo "2) Редактировать конфиг (nano)"
    echo "3) Выход"
    read -p "Выберите действие: " choice
    case $choice in
        1) echo "Мониторинг газа активен...";;
        2) nano config.sh ;;
        3) exit ;;
        *) echo "Неверный ввод!";;
    esac
done
